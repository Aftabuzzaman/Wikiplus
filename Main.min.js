"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();$(function(){function a(a){var b=window.navigator.language.toLowerCase();return c[b][a]?c[b][a]:c["zh-cn"][a]?c["zh-cn"][a]:"undefined"}function b(b){var c={unknown_error_name:{number:1001,message:a("unknown_error_name")},api_unaccessiable:{number:1002},api_unwriteable:{number:1003},fail_to_get_timestamp:{number:1004},fail_to_get_edittoken:{number:1005},fail_to_get_pageinfo:{number:1006},not_autoconfirmed_user:{number:1007},hit_abusefilter:{number:1008},unknown_edit_error:{number:1009},unknown_edit_error_message:{number:1010},notitle:{number:1011},notext:{number:1012},notoken:{number:1013},invalidsection:{number:1014},protectedtitle:{number:1015},cantcreate:{number:1016},cantcreate_anon:{number:1017},articleexists:{number:1018},noimageredirect_anon:{number:1019},noimageredirect:{number:1020},spamdetected:{number:1021},filtered:{number:1022},contenttoobig:{number:1023},noedit_anon:{number:1025},noedit:{number:1026},pagedeleted:{number:1027},emptypage:{number:1028},emptynewsection:{number:1029},editconflict:{number:1030},revwrongpage:{number:1031},undofailure:{number:1032},missingtitle:{number:1033},mustbeposted:{number:1034},readapidenied:{number:1035},writeapidenied:{number:1036},noapiwrite:{number:1037},badtoken:{number:1038},missingparam:{number:1039},invalidparammix:{number:1040},invalidtitle:{number:1041},nosuchpageid:{number:1042},pagecannotexist:{number:1043},nosuchrevid:{number:1044},badmd5:{number:1045},hookaborted:{number:1046},parseerror:{number:1047},summaryrequired:{number:1048},blocked:{number:1049},ratelimited:{number:1050},unknownerror:{number:1051},nosuchsection:{number:1052},sectionsnotsupported:{number:1053},editnotsupported:{number:1054},appendnotsupported:{number:1055},redirect_appendonly:{number:1056},badformat:{number:1057},customcssprotected:{number:1058},customjsprotected:{number:1059},cascadeprotected:{number:1060},network_edit_error:{number:1061}};return c[b]?c[b].message?{number:c[b].number,message:c[b].message}:"undefined"!==a(b)?{number:c[b].number,message:a(b)}:{number:c[b].number,message:"未知错误"}:{number:c.unknown_error_name.number,message:c.unknown_error_name.message}}var c={};c["zh-cn"]={__language:"zh-cn",__author:"Eridanus Sora",unknown_error_name:"未知的错误名",api_unaccessiable:"无可用的API",api_unwriteable:"无可用的写入API",fail_to_get_timestamp:"无法获得页面编辑起始时间戳",fail_to_get_edittoken:"无法获得页面编辑权标",fail_to_get_pageinfo:"无法获得页面信息",not_autoconfirmed_user:"非自动确认用户",hit_abusefilter:"被防滥用过滤器拦截",unknown_edit_error:"未知编辑错误",unknown_edit_error_message:"未知编辑错误($1)",notitle:"无法编辑空标题页面",notext:"缺少页面内容",notoken:"空编辑权标",invalidsection:"段落编号非法",protectedtitle:"该标题被保护，无法创建",cantcreate:"无新建页面权限",cantcreate_anon:"匿名用户无新建页面权限",articleexists:"无法创建已经存在的页面",noimageredirect_anon:"匿名用户无新建文件重定向权限",noimageredirect:"无新建文件重定向权限",spamdetected:"文本含有敏感内容，被SPAM过滤器拦截",filtered:"编辑被过滤器拦截",contenttoobig:"文本超过最大长度限制",noedit_anon:"匿名用户无编辑页面权限",noedit:"无编辑页面权限",pagedeleted:"编辑时，此页面被删除",emptypage:"无法新建空内容页面",emptynewsection:"无法新建空内容段落",editconflict:"编辑冲突，请手工检查页面当前内容与提交内容差异并修正后，刷新页面提交",revwrongpage:"编辑的修订版本与编辑的页面不匹配",undofailure:"由于存在冲突的中间版本，无法撤销编辑",missingtitle:"无法创建或编辑空标题页面",mustbeposted:"必须使用POST方式提交编辑",readapidenied:"无读取API使用权限",writeapidenied:"无通过API编辑页面权限",noapiwrite:"本Wiki未开启可用的写入API",badtoken:"非法的编辑权标",missingparam:"缺少必要参数，页面名和页面ID不能均为空",invalidparammix:"参数重复，页面名和页面ID不能同时给定",invalidtitle:"非法的标题",nosuchpageid:"不存在的页面ID",pagecannotexist:"该名称空间不允许新建一般页面",nosuchrevid:"不存在的修订版本",badmd5:"非法的MD5值",hookaborted:"编辑被扩展Hook拦截",parseerror:"无法解析页面文本",summaryrequired:"编辑摘要不能为空",blocked:"已被封禁",ratelimited:"达到操作速率上限，请稍后重试",unknownerror:"未知错误",nosuchsection:"无法编辑不存在的段落",sectionsnotsupported:"该页面不支持段落编辑",editnotsupported:"该页面不支持通过API编辑",appendnotsupported:"该页面无法在前后插入文本",redirect_appendonly:"在遵循重定向的情况下，只能进行前后插入或创建新段落",badformat:"文本格式错误",customcssprotected:"无法编辑用户CSS页",customjsprotected:"无法编辑用户JS页",cascadeprotected:"该页面被级联保护",network_edit_error:"由于网络原因编辑失败"};var d=function(){function c(){var a=arguments.length<=0||void 0===arguments[0]?window.mw.config.values.wgPageName:arguments[0];_classCallCheck(this,c);var b=this;return console.log("页面类构建中"),window.mw?window.mw.config.values.wgEnableAPI&&window.mw.config.values.wgEnableWriteAPI?b.inArray("autoconfirmed",window.mw.config.values.wgUserGroups)?(b.pageName=a.replace(/ /gi,"_"),b.revisionId=window.mw.config.values.wgRevisionId,b.articleId=window.mw.config.values.wgArticleId,b.API=location.protocol+"//"+location.host+window.mw.config.values.wgScriptPath+"/api.php",void $.ajax({type:"GET",dataType:"json",url:b.API,data:{action:"query",prop:"revisions|info",titles:b.pageName,rvprop:"timestamp",intoken:"edit",format:"json"},beforeSend:function(){console.time("获得页面基础信息时间耗时")},success:function(a){if(a&&a.query&&a.query.pages){var c=a.query.pages;for(var d in c)"-1"!==d?(c[d].revisions&&c[d].revisions.length>0?b.timeStamp=c[d].revisions[0].timestamp:b.throwError("fail_to_get_timestamp"),c[d].edittoken&&("+\\"!=c[d].edittoken?b.editToken=c[d].edittoken:(console.log("无法通过API获得编辑令牌，可能是空页面，尝试通过前端API获取通用编辑令牌"),b.editToken=window.mw.user.tokens.get("editToken"),b.editToken&&"+\\"!=b.editToken?console.log("成功获得通用编辑令牌 来自前端API"):b.throwError("fail_to_get_edittoken")))):(b.throwError("fail_to_get_pageinfo"),b.inited=!0)}}}).done(function(){console.timeEnd("获得页面基础信息时间耗时")})):void b.throwError("not_autoconfirmed_user"):void b.throwError("api_unaccessiable"):void console.log("页面Javascript载入不完全或这不是一个Mediawiki站点")}return _createClass(c,[{key:"inArray",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?[]:arguments[1];return-1===$.inArray(a,b)?!1:!0}},{key:"throwError",value:function(a,c){var d=b(a),e=new Error;return e.number=d.number,e.message=c||d.message,console.log("%c致命错误["+e.number+"]:"+e.message,"color:red"),e}}]),_createClass(c,[{key:"edit",value:function(){var b=arguments.length<=0||void 0===arguments[0]?"":arguments[0],c=arguments.length<=1||void 0===arguments[1]?this.pageName:arguments[1],d=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],e=arguments.length<=3||void 0===arguments[3]?{success:new Function,fail:new Function}:arguments[3],f=this;f.inited?$.ajax({type:"POST",url:f.API,data:$.extend({action:"edit",format:"json",text:b,title:c,token:f.editToken,basetimestamp:f.timeStamp},d),success:function(b){b&&b.edit?b.edit.result&&"Success"==b.edit.result?e.success():b.edit.code?e.fail(f.throwError("hit_abusefilter","触发防滥用过滤器:"+b.edit.info.replace("/Hit AbuseFilter: /ig","")+"<br><small>"+b.edit.warning+"</small>")):e.fail(f.throwError("unknown_edit_error")):b&&b.error&&b.error.code?e.fail(f.throwError(b.error.code.replace(/-/gi,"_")),a("unknown_edit_error_message").replace(/\$1/gi,b.error.code)):b.code?e.fail(f.throwError("unknown_edit_error"),a("unknown_edit_error_message").replace(/\$1/gi,b.code)):e.fail(f.throwError("unknown_edit_error"))},error:function(a){e.fail(f.throwError("network_edit_error"))}}):e.fail(f.throwError(1017,"页面类未加载完成"))}}]),c}();$(document).ready(function(){var a=function b(){_classCallCheck(this,b);var a=this;this.version="2.0",this.releaseNote="重构",console.log("正在加载Wikiplus"),a.kotori=new d};new a})});