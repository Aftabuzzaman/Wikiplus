"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();$(function(){var a=function(){function a(){var b=arguments.length<=0||void 0===arguments[0]?window.mw.config.values.wgPageName:arguments[0];_classCallCheck(this,a);var c=this;return console.log("页面类构建中"),window.mw?window.mw.config.values.wgEnableAPI&&window.mw.config.values.wgEnableWriteAPI?c.inArray("autoconfirmed",window.mw.config.values.wgUserGroups)?(c.pageName=b.replace(/ /gi,"_"),c.revisionId=window.mw.config.values.wgRevisionId,c.articleId=window.mw.config.values.wgArticleId,c.API=location.protocol+"//"+location.host+window.mw.config.values.wgScriptPath+"/api.php",c.languages={},c.languages["zh-cn"]={fail_to_get_timestamp:"无法获得页面时间戳"},c.i18n=function(a){},c.errorList={fail_to_get_timestamp:{number:1004,message:c.i18n("fail_to_get_timestamp")}},c.throwError=function(a){var b=this;b.errorList[a]||(a="unknown_error_name");var c=new Error;return console.log(b.errorList[a]),c.number=b.errorList[a].number,c.message=b.errorList[a].message,console.log("%c致命错误["+c.number+"]:"+c.message,"color:red"),c},c.throwError("fail_to_get_timestamp"),void $.ajax({type:"GET",dataType:"json",url:c.API,data:{action:"query",prop:"revisions|info",titles:c.pageName,rvprop:"timestamp",intoken:"edit",format:"json"},beforeSend:function(){console.time("获得页面基础信息时间耗时")},success:function(a){if(a&&a.query&&a.query.pages){var b=a.query.pages;for(var d in b)"-1"!==d?(b[d].revisions&&b[d].revisions.length>0?c.timeStamp=b[d].revisions[0].timestamp:c.throwError(1004,"无法获得页面时间戳"),b[d].edittoken&&("+\\"!=b[d].edittoken?c.editToken=b[d].edittoken:(console.log("无法通过API获得编辑令牌，可能是空页面，尝试通过前端API获取通用编辑令牌"),c.editToken=window.mw.user.tokens.get("editToken"),c.editToken&&"+\\"!=c.editToken?console.log("成功获得通用编辑令牌 来自前端API"):c.throwError(1005,"无法获得页面编辑令牌 请确认登录状态")))):(c.throwError(1007,"无法获得页面基础信息"),c.inited=!0)}}}).done(function(){console.timeEnd("获得页面基础信息时间耗时")})):void c.throwError(1001,"非自动确认用户"):void c.throwError(1e3,"无可用的API"):void console.log("页面Javascript载入不完全或这不是一个Mediawiki站点")}return _createClass(a,[{key:"throwError",value:function(a){}},{key:"inArray",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?[]:arguments[1];return-1===$.inArray(a,b)?!1:!0}}]),_createClass(a,[{key:"edit",value:function(){var a=arguments.length<=0||void 0===arguments[0]?this.pageName:arguments[0],b=arguments.length<=1||void 0===arguments[1]?"":arguments[1],c=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],d=arguments.length<=3||void 0===arguments[3]?{success:new Function,fail:new Function}:arguments[3],e=this;e.inited?$.ajax({type:"POST",url:e.API,data:$.extend({action:"edit",format:"json",text:b,title:a,token:e.editToken,basetimestamp:e.timeStamp},c),success:function(a){a&&a.edit?a.edit.result&&"Success"==a.edit.result?d.success():a.edit.code?d.fail(e.throwError(1018,"触发防滥用过滤器:"+a.edit.info.replace("/Hit AbuseFilter: /ig","")+"<br><small>"+a.edit.warning+"</small>")):d.fail(e.throwError(1019,"未知编辑错误")):a&&a.error&&a.error.code&&a.error.code}}):d.fail(e.throwError(1017,"页面类未加载完成"))}}]),a}();$(document).ready(function(){var b=function c(){_classCallCheck(this,c);var b=this;this.version="2.0",this.releaseNote="重构;",console.log("正在加载Wikiplus"),b.kotori=new a};new b})});